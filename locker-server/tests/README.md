# 🔒 사물함 예약 시스템 테스트 스위트

이 디렉토리는 사물함 예약 시스템의 포괄적인 테스트 도구들을 포함합니다.  
**대학교 규모의 대용량 트래픽**과 **극한 동시성 상황**에서의 시스템 검증이 완료되었습니다.

## 📁 파일 구조

```
tests/
├── __init__.py                 # Python 패키지 초기화
├── README.md                  # 이 파일 (포괄적 테스트 가이드)
├── load_test.py              # 🚀 대규모 부하 테스트 (1000명 사용자)
├── load_test_config.py       # ⚙️ 테스트 설정 파일 (150개 사물함)
├── race_test.py              # ⚡ Race Condition 테스트 (10명 동시 경쟁)
├── quick_test.py             # 🏃 빠른 기능 테스트
├── run_load_test.sh          # 📜 부하 테스트 실행 스크립트 (Bash)
├── LOAD_TEST_README.md       # 📖 부하 테스트 상세 가이드
└── load_test_results.json    # 📊 최신 테스트 결과
```

## 🚀 테스트 실행 방법

### 1. 🎯 대규모 부하 테스트 (검증 완료!)
**1000명 사용자, 300명 동시접속, 150개 사물함** 시나리오:
```bash
cd tests
python load_test.py
```
**최신 성과**: 85.90% 성공률, 1,768 req/sec 처리량 ✅

### 2. ⚡ Race Condition 테스트 (극한 동시성 검증!)
**10명이 동시에 하나의 사물함을 두고 경쟁** 시나리오:
```bash
cd tests
python race_test.py
```
**검증 결과**: 정확히 1명 승리, 9명 409 에러 - 완벽한 동시성 제어 ✅

### 3. 🏃 빠른 기능 테스트
기본 기능 검증:
```bash
cd tests
python quick_test.py
```

### 4. 🔧 사용자 정의 설정 테스트
```bash
cd tests
python load_test.py --users 100 --concurrent 50 --lockers 50
```

## ⚙️ 테스트 설정

`load_test_config.py`에서 테스트 매개변수를 조정할 수 있습니다:

```python
# 🎯 대규모 부하 테스트 설정 (검증 완료)
TOTAL_USERS = 1000        # 총 사용자 수
CONCURRENT_USERS = 300    # 동시 접속 사용자 수 (대학교 피크 시간 시뮬레이션)
TEST_LOCKERS_COUNT = 150  # 테스트용 사물함 수 (충분한 경쟁 상황 조성)
BATCH_DELAY = 0.5         # 배치 간 대기 시간 (초)

# ⚡ Race Condition 테스트 설정 (극한 검증)
RACE_USERS = 10           # 동시 경쟁할 사용자 수 (한 사물함 대상)

# 🌐 서버 설정
BASE_URL = "http://localhost:3000"
```

## 📊 **검증된 성능 지표**

### 🏆 대규모 부하 테스트 결과
- **총 요청**: 3,092개
- **성공률**: 85.90% ✅
- **평균 응답시간**: 0.061초
- **처리량**: 1,768 req/sec
- **소유권 검증**: 100% 정확성 ✅

### ⚡ Race Condition 테스트 결과
- **승자**: 정확히 1명 ✅
- **실패자**: 9명 (모두 409 에러)
- **동시성 제어**: 완벽한 Redis 기반 Hold 메커니즘 ✅
- **응답시간**: 평균 0.001-0.003초

## 🎯 테스트 기능

### 🚀 대규모 부하 테스트 (load_test.py) - **검증 완료!**
- **대학교 규모 시뮬레이션**: 1000명 사용자, 300명 동시 접속
- **완전한 시나리오**: Login → 사물함 조회 → Hold → Confirm → 소유권 검증
- **경쟁 상황 처리**: 실제 대학 환경의 사물함 경쟁 시뮬레이션 (150개 사물함)
- **성능 측정**: 응답시간, 처리량, 성공률, 엔드포인트별 세부 통계
- **자동 데이터 관리**: 백업/복원으로 원본 데이터 완전 보호
- **검증된 성과**: 85.90% 성공률, 1,768 req/sec 처리량 ✅

### ⚡ Race Condition 테스트 (race_test.py) - **극한 검증 완료!**
- **극한 동시성 검증**: 10명이 동일한 사물함에 동시 경쟁
- **정확성 검증**: 정확히 1명만 성공하는지 확인 (100% 성공)
- **실시간 모니터링**: 요청 순서와 결과 타이밍 마이크로초 단위 분석
- **시스템 안정성**: Redis 기반 Hold 메커니즘의 완벽한 동작 검증 ✅
- **자동 정리**: 10명의 테스트 사용자 생성 및 완전 정리

### 🏃 빠른 기능 테스트 (quick_test.py)
- **API 연결성**: 모든 엔드포인트 접근 가능성 확인
- **기본 인증**: 로그인/토큰 기능 검증
- **CRUD 작업**: 사물함 조회/점유/확정/해제 테스트

## 📈 테스트 결과 해석

### 🏆 성공적인 부하 테스트 지표 (검증 완료)
- **성공률**: 85.90% ✅ (대학교 환경에서 우수한 수준)
- **평균 응답시간**: 0.061초 ✅ (매우 빠른 응답)
- **처리량**: 1,768 req/sec ✅ (대용량 트래픽 처리 가능)
- **소유권 검증**: 100% 정확성 ✅ (데이터 정합성 완벽)
- **데이터 정리**: 원본 상태 완전 복원 ✅

### ⚡ Race Condition 테스트 결과 (극한 검증)
```
✅ PERFECT: Exactly 1 user won (정확히 1명 승리 - 완벽한 동시성 제어)
   🏆 Winners: 1
   ❌ Failures: 9 (모두 409 에러 - 정상적인 경쟁 실패)
   ⚡ Response Time: 0.001-0.003초 (초고속 처리)
```

### 🚨 경고 신호 (현재 발생 안 함)
```
⚠️  WARNING: Multiple users won (잠재적 race condition 버그)
❌ ERROR: No users won (시스템 다운 가능성)
```

### 📊 HTTP 응답 코드 분석
- **200/201**: 성공 (사물함 점유/확정 성공)
- **409**: 이미 점유됨 (정상적인 경쟁 상황) ✅
- **401**: 인증 실패
- **404**: 사물함 없음
- **500**: 서버 내부 오류 (테스트에서 발생 안 함) ✅

## 🛠️ 개발자 가이드

### 🎯 새로운 테스트 시나리오 추가
1. `tests/` 디렉토리에 새 Python 파일 생성
2. `load_test_config.py`에서 설정 import
3. `TestDataManager` 클래스 활용하여 데이터 관리 (자동 백업/복원)
4. 테스트 완료 후 정리 로직 필수 포함

### 📏 테스트 규모별 설정 예시

#### 🧪 소규모 테스트 (개발 중)
```python
TOTAL_USERS = 10
CONCURRENT_USERS = 5
TEST_LOCKERS_COUNT = 20
```

#### 🏢 중간 규모 테스트 (스테이징)
```python
TOTAL_USERS = 100
CONCURRENT_USERS = 50
TEST_LOCKERS_COUNT = 100
```

#### 🏫 대규모 테스트 (운영 전 검증) ✅ **검증 완료**
```python
TOTAL_USERS = 1000        # 대학교 전체 학생 수준
CONCURRENT_USERS = 300    # 수강신청, 시험기간 동시 접속
TEST_LOCKERS_COUNT = 150  # 실제 사물함 수량 수준
```

#### ⚡ 극한 동시성 테스트 ✅ **검증 완료**
```python
RACE_USERS = 10          # 인기 사물함 동시 경쟁 극한 상황
TARGET_LOCKER = 1        # 하나의 사물함을 두고 경쟁
```

## ⚠️ 주의사항

1. **서버 실행 필수**: 테스트 전 Go 서버가 3000번 포트에서 실행 중이어야 함
2. **데이터베이스 연결**: PostgreSQL과 Redis가 정상 동작해야 함
3. **원본 데이터 보호**: 홍길동(20231234), 김철수(20231235) 사용자는 절대 삭제되지 않음
4. **테스트 격리**: 각 테스트는 독립적으로 실행되며 서로 영향을 주지 않음
5. **정리 검증**: 테스트 완료 후 "Database restored to original clean state" 메시지 확인 필수

## 🔍 트러블슈팅

### 자주 발생하는 문제
1. **연결 거부**: 서버가 실행되지 않음 → `make run` 실행
2. **로그인 실패**: 사용자 데이터 없음 → 먼저 `load_test.py` 실행하여 사용자 생성
3. **외래키 오류**: 정리 순서 문제 → race_test.py의 개선된 정리 로직 사용
4. **모든 사용자 409**: 이전 테스트 데이터 잔존 → 완전한 정리 후 재실행

### 디버깅 팁
- 각 테스트는 상세한 로그를 출력합니다
- `load_test_results.json`에서 상세한 결과 확인 가능
- 실패 시 에러 메시지와 HTTP 상태 코드를 확인하세요

---

## 🎉 **최종 검증 결과**

### ✅ **시스템 안정성 완전 검증**
1. **대용량 트래픽 처리**: 1000명 사용자, 300명 동시 접속 ✅
2. **극한 동시성 제어**: 10명이 하나의 사물함을 두고 경쟁 ✅
3. **데이터 정합성**: 100% 정확한 소유권 관리 ✅
4. **응답 성능**: 평균 0.061초, 최대 1,768 req/sec ✅
5. **시스템 복구력**: 완벽한 데이터 백업/복원 시스템 ✅

### 🏆 **대학교 환경 준비 완료**
- **수강신청 수준**: 대규모 동시 접속 처리 가능
- **시험기간 사용량**: 극한 사물함 경쟁 상황 대응
- **일상적 운영**: 빠른 응답과 안정적인 서비스
- **데이터 보호**: 기존 사용자 데이터 완전 보호

**마지막 업데이트**: 2025년 9월 6일  
**테스트 환경**: Go Fiber 서버 + PostgreSQL + Redis  
**검증 상태**: 대학교 운영 환경 완전 준비 완료 🎓✨

## 📞 문의

테스트 관련 문의사항이나 이슈가 있으면 개발팀에 연락해주세요.
